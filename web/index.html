<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Net Finder - Network Scanner</title>
<style>
:root {
  --bg: #f5f5f5;
  --surface: #ffffff;
  --text: #1a1a1a;
  --text-secondary: #666;
  --border: #e0e0e0;
  --primary: #1976d2;
  --primary-light: #e3f2fd;
  --danger: #d32f2f;
  --danger-light: #ffebee;
  --warning: #f57f17;
  --warning-light: #fff8e1;
  --success: #388e3c;
  --success-light: #e8f5e9;
  --cyan: #0097a7;
  --tab-bg: #e8e8e8;
  --tab-active: #ffffff;
  --shadow: 0 1px 3px rgba(0,0,0,0.12);
  --progress-bg: #e0e0e0;
}
[data-theme="dark"] {
  --bg: #121212;
  --surface: #1e1e1e;
  --text: #e0e0e0;
  --text-secondary: #999;
  --border: #333;
  --primary: #64b5f6;
  --primary-light: #1a2733;
  --danger: #ef5350;
  --danger-light: #2c1515;
  --warning: #ffb74d;
  --warning-light: #2c2210;
  --success: #66bb6a;
  --success-light: #152215;
  --cyan: #4dd0e1;
  --tab-bg: #2a2a2a;
  --tab-active: #1e1e1e;
  --shadow: 0 1px 3px rgba(0,0,0,0.4);
  --progress-bg: #333;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
}
.container { max-width: 1400px; margin: 0 auto; padding: 16px; }
header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}
header h1 { font-size: 20px; font-weight: 600; }
header h1 span { color: var(--primary); }
.header-controls { display: flex; align-items: center; gap: 12px; }
.btn {
  padding: 6px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: opacity 0.2s;
}
.btn:hover { opacity: 0.85; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.lang-select {
  padding: 4px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--surface);
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
  outline: none;
}
.lang-select:hover { border-color: var(--primary); }
.theme-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
  cursor: pointer;
  user-select: none;
}
.theme-toggle input { display: none; }
.toggle-track {
  width: 36px;
  height: 20px;
  background: var(--border);
  border-radius: 10px;
  position: relative;
  transition: background 0.2s;
}
.toggle-track::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.2s;
}
.theme-toggle input:checked + .toggle-track {
  background: var(--primary);
}
.theme-toggle input:checked + .toggle-track::after {
  transform: translateX(16px);
}
.progress-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 16px;
  margin: 16px 0;
  box-shadow: var(--shadow);
}
.progress-bar-container {
  width: 100%;
  height: 8px;
  background: var(--progress-bg);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 8px;
}
.progress-bar {
  height: 100%;
  background: var(--primary);
  border-radius: 4px;
  transition: width 0.3s;
  width: 0%;
}
.progress-text {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: var(--text-secondary);
}
.status-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 500;
}
.status-idle { background: var(--border); color: var(--text-secondary); }
.status-running { background: var(--primary-light); color: var(--primary); }
.status-done { background: var(--success-light); color: var(--success); }
.tabs {
  display: flex;
  background: var(--tab-bg);
  border-radius: 6px 6px 0 0;
  overflow-x: auto;
  margin-top: 16px;
}
.tab {
  padding: 10px 20px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  position: relative;
  transition: all 0.2s;
}
.tab:hover { color: var(--text); }
.tab.active {
  background: var(--tab-active);
  color: var(--primary);
  border-radius: 6px 6px 0 0;
}
.tab .badge {
  display: inline-block;
  min-width: 18px;
  height: 18px;
  line-height: 18px;
  padding: 0 5px;
  border-radius: 9px;
  font-size: 11px;
  font-weight: 600;
  text-align: center;
  margin-left: 6px;
  color: #fff;
}
.badge-danger { background: var(--danger); }
.badge-warning { background: var(--warning); }
.badge-info { background: var(--primary); }
.tab-content {
  background: var(--surface);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 6px 6px;
  padding: 16px;
  min-height: 300px;
  box-shadow: var(--shadow);
}
.panel { display: none; }
.panel.active { display: block; }
.search-box {
  width: 100%;
  max-width: 300px;
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 13px;
  background: var(--bg);
  color: var(--text);
  margin-bottom: 12px;
}
.search-box::placeholder { color: var(--text-secondary); }
.subnet-filter {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
  align-items: center;
}
.subnet-filter label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
  cursor: pointer;
  user-select: none;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
th, td {
  padding: 8px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
th {
  background: var(--bg);
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
  position: sticky;
  top: 0;
}
th:hover { background: var(--primary-light); }
th .sort-arrow { margin-left: 4px; font-size: 10px; }
tr:hover { background: var(--primary-light); }
tr.subnet-header:hover { background: var(--primary-light); }
.subnet-header {
  background: var(--bg);
  cursor: pointer;
  user-select: none;
}
.subnet-header td {
  font-weight: 600;
  font-size: 13px;
  padding: 10px 12px 6px;
  border-bottom: 2px solid var(--primary);
  color: var(--primary);
}
.subnet-header .subnet-count {
  font-weight: 400;
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 8px;
}
.collapse-arrow {
  display: inline-block;
  width: 14px;
  font-size: 11px;
  transition: transform 0.15s;
}
.text-danger { color: var(--danger); }
.text-warning { color: var(--warning); }
.text-success { color: var(--success); }
.text-cyan { color: var(--cyan); }
.severity-warning {
  background: var(--warning-light);
  border-left: 3px solid var(--warning);
}
.severity-critical {
  background: var(--danger-light);
  border-left: 3px solid var(--danger);
}
.empty-state {
  text-align: center;
  padding: 48px 16px;
  color: var(--text-secondary);
}
.empty-state p { font-size: 14px; }
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.info-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
}
.info-card h4 { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.info-card .value { font-size: 16px; font-weight: 600; }
.mac-cell { font-family: 'Courier New', monospace; font-size: 12px; }
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal {
  background: var(--surface);
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  max-width: 520px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.modal-header h3 { font-size: 16px; font-weight: 600; }
.modal-header button {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: var(--text-secondary);
  padding: 0 4px;
}
.modal-header button:hover { color: var(--text); }
.modal-body { padding: 20px; }
.modal-footer {
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.form-group { margin-bottom: 14px; }
.form-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 4px;
}
.form-label.required::after {
  content: ' *';
  color: #d32f2f;
  color: var(--text-secondary);
}
.form-input {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 13px;
  background: var(--bg);
  color: var(--text);
}
.form-input:focus { outline: none; border-color: var(--primary); }
.subnet-select {
  max-height: 160px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 8px;
  background: var(--bg);
}
.subnet-select label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  cursor: pointer;
  padding: 2px 0;
}
.alert-list {
  padding: 12px 20px 16px;
  border-top: 1px solid var(--border);
}
.alert-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  margin-bottom: 6px;
  font-size: 13px;
}
.alert-list-item .alert-info { flex: 1; }
.alert-list-item .alert-info strong { color: var(--primary); }
.btn-sm {
  padding: 3px 10px;
  font-size: 12px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}
.btn-sm:hover { opacity: 0.85; }
.alert-msg {
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 13px;
  margin-top: 8px;
}
.alert-msg-ok { background: var(--success-light); color: var(--success); }
.alert-msg-err { background: var(--danger-light); color: var(--danger); }
@media (max-width: 768px) {
  .container { padding: 8px; }
  header { padding: 8px 12px; flex-wrap: wrap; gap: 8px; }
  .tabs { flex-wrap: nowrap; }
  .tab { padding: 8px 12px; font-size: 12px; }
  th, td { padding: 6px 8px; font-size: 12px; }
  .info-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<header>
  <h1><span>Net Finder</span></h1>
  <div class="header-controls">
    <button id="btnScan" class="btn btn-primary" onclick="startScan()" data-i18n="btn_scan">Start Scan</button>
    <button id="btnStop" class="btn btn-danger" onclick="stopScan()" disabled data-i18n="btn_stop">Stop Scan</button>
    <button class="btn" onclick="openAlertModal()" data-i18n="btn_alert_config">Alert Settings</button>
    <select id="langSelect" class="lang-select" onchange="setLanguage(this.value)">
      <option value="en">EN</option>
      <option value="ko">KO</option>
    </select>
    <label class="theme-toggle">
      <input type="checkbox" id="themeSwitch" onchange="toggleTheme()">
      <span class="toggle-track"></span>
      <span data-i18n="dark_mode">Dark</span>
    </label>
  </div>
</header>

<div class="container">
  <div class="progress-section">
    <div class="progress-text">
      <span><span class="status-badge status-idle" id="statusBadge" data-i18n="status_idle">Idle</span> <span id="progressDesc"></span></span>
      <span id="progressPercent">0%</span>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

  <div class="tabs" id="tabBar">
    <button class="tab active" data-tab="hosts" onclick="switchTab('hosts')"><span data-i18n="tab_hosts">Hosts</span> <span class="badge badge-info" id="badge-hosts" style="display:none">0</span></button>
    <button class="tab" data-tab="conflicts" onclick="switchTab('conflicts')"><span data-i18n="tab_conflicts">IP Conflicts</span> <span class="badge badge-danger" id="badge-conflicts" style="display:none">0</span></button>
    <button class="tab" data-tab="dhcp" onclick="switchTab('dhcp')"><span data-i18n="tab_dhcp">DHCP Servers</span> <span class="badge badge-info" id="badge-dhcp" style="display:none">0</span></button>
    <button class="tab" data-tab="protocols" onclick="switchTab('protocols')">HSRP/VRRP</button>
    <button class="tab" data-tab="discovery" onclick="switchTab('discovery')">LLDP/CDP</button>
    <button class="tab" data-tab="security" onclick="switchTab('security')"><span data-i18n="tab_security">Security</span> <span class="badge badge-danger" id="badge-security" style="display:none">0</span></button>
  </div>

  <div class="tab-content">
    <!-- Hosts Panel -->
    <div class="panel active" id="panel-hosts">
      <input type="text" class="search-box" data-i18n-placeholder="search_hosts" placeholder="Search (IP, hostname, MAC, vendor...)" oninput="filterTable('hosts-table', this.value)">
      <div class="subnet-filter" id="subnet-filter-hosts"></div>
      <div style="overflow-x:auto">
      <table id="hosts-table">
        <thead>
          <tr>
            <th onclick="sortTable('hosts-table',0)">#<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hosts-table',1)">IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hosts-table',2)" data-i18n="th_hostname">Hostname<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hosts-table',3)">MAC<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hosts-table',4)" data-i18n="th_vendor">Vendor<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-hosts"><p data-i18n="empty_hosts">Discovered hosts will appear here once scanning starts.</p></div>
    </div>

    <!-- Conflicts Panel -->
    <div class="panel" id="panel-conflicts">
      <input type="text" class="search-box" data-i18n-placeholder="search_generic" placeholder="Search..." oninput="filterTable('conflicts-table', this.value)">
      <div class="subnet-filter" id="subnet-filter-conflicts"></div>
      <div style="overflow-x:auto">
      <table id="conflicts-table">
        <thead>
          <tr>
            <th onclick="sortTable('conflicts-table',0)">IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('conflicts-table',1)" data-i18n="th_hostname">Hostname<span class="sort-arrow"></span></th>
            <th onclick="sortTable('conflicts-table',2)" data-i18n="th_mac_addr">MAC Address<span class="sort-arrow"></span></th>
            <th onclick="sortTable('conflicts-table',3)" data-i18n="th_vendor">Vendor<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-conflicts"><p data-i18n="empty_conflicts">No IP conflicts detected.</p></div>
    </div>

    <!-- DHCP Panel -->
    <div class="panel" id="panel-dhcp">
      <div style="overflow-x:auto">
      <table id="dhcp-table">
        <thead>
          <tr>
            <th onclick="sortTable('dhcp-table',0)" data-i18n="th_server_ip">Server IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dhcp-table',1)" data-i18n="th_server_mac">Server MAC<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dhcp-table',2)" data-i18n="th_vendor">Vendor<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dhcp-table',3)" data-i18n="th_offered_ip">Offered IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dhcp-table',4)" data-i18n="th_subnet">Subnet<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dhcp-table',5)" data-i18n="th_gateway">Gateway<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dhcp-table',6)">DNS<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dhcp-table',7)" data-i18n="th_lease">Lease Time<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-dhcp"><p data-i18n="empty_dhcp">No DHCP servers detected.</p></div>
    </div>

    <!-- HSRP/VRRP Panel -->
    <div class="panel" id="panel-protocols">
      <h3 style="margin-bottom:12px">HSRP</h3>
      <div style="overflow-x:auto">
      <table id="hsrp-table">
        <thead>
          <tr>
            <th onclick="sortTable('hsrp-table',0)" data-i18n="th_version">Version<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hsrp-table',1)" data-i18n="th_group">Group<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hsrp-table',2)" data-i18n="th_state">State<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hsrp-table',3)" data-i18n="th_priority">Priority<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hsrp-table',4)" data-i18n="th_virtual_ip">Virtual IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hsrp-table',5)" data-i18n="th_source_ip">Source IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hsrp-table',6)">Hello/Hold<span class="sort-arrow"></span></th>
            <th onclick="sortTable('hsrp-table',7)" data-i18n="th_time">Time<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-hsrp"><p data-i18n="empty_hsrp">No HSRP packets detected.</p></div>

      <h3 style="margin:24px 0 12px">VRRP</h3>
      <div style="overflow-x:auto">
      <table id="vrrp-table">
        <thead>
          <tr>
            <th onclick="sortTable('vrrp-table',0)" data-i18n="th_version">Version<span class="sort-arrow"></span></th>
            <th onclick="sortTable('vrrp-table',1)" data-i18n="th_router_id">Router ID<span class="sort-arrow"></span></th>
            <th onclick="sortTable('vrrp-table',2)" data-i18n="th_priority">Priority<span class="sort-arrow"></span></th>
            <th onclick="sortTable('vrrp-table',3)" data-i18n="th_virtual_ip">Virtual IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('vrrp-table',4)" data-i18n="th_source_ip">Source IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('vrrp-table',5)" data-i18n="th_adver_int">Adver Int<span class="sort-arrow"></span></th>
            <th onclick="sortTable('vrrp-table',6)" data-i18n="th_time">Time<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-vrrp"><p data-i18n="empty_vrrp">No VRRP packets detected.</p></div>
    </div>

    <!-- LLDP/CDP Panel -->
    <div class="panel" id="panel-discovery">
      <h3 style="margin-bottom:12px" data-i18n="h_lldp">LLDP Neighbors</h3>
      <div style="overflow-x:auto">
      <table id="lldp-table">
        <thead>
          <tr>
            <th onclick="sortTable('lldp-table',0)">Chassis ID<span class="sort-arrow"></span></th>
            <th onclick="sortTable('lldp-table',1)">Port ID<span class="sort-arrow"></span></th>
            <th onclick="sortTable('lldp-table',2)" data-i18n="th_sys_name">System Name<span class="sort-arrow"></span></th>
            <th onclick="sortTable('lldp-table',3)" data-i18n="th_sys_desc">System Desc<span class="sort-arrow"></span></th>
            <th onclick="sortTable('lldp-table',4)" data-i18n="th_mgmt_addr">Mgmt Address<span class="sort-arrow"></span></th>
            <th onclick="sortTable('lldp-table',5)" data-i18n="th_source_mac">Source MAC<span class="sort-arrow"></span></th>
            <th onclick="sortTable('lldp-table',6)">TTL<span class="sort-arrow"></span></th>
            <th onclick="sortTable('lldp-table',7)" data-i18n="th_time">Time<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-lldp"><p data-i18n="empty_lldp">No LLDP neighbors detected.</p></div>

      <h3 style="margin:24px 0 12px" data-i18n="h_cdp">CDP Neighbors</h3>
      <div style="overflow-x:auto">
      <table id="cdp-table">
        <thead>
          <tr>
            <th onclick="sortTable('cdp-table',0)" data-i18n="th_device_id">Device ID<span class="sort-arrow"></span></th>
            <th onclick="sortTable('cdp-table',1)" data-i18n="th_address">Address<span class="sort-arrow"></span></th>
            <th onclick="sortTable('cdp-table',2)" data-i18n="th_source_mac">Source MAC<span class="sort-arrow"></span></th>
            <th onclick="sortTable('cdp-table',3)">Port ID<span class="sort-arrow"></span></th>
            <th onclick="sortTable('cdp-table',4)" data-i18n="th_platform">Platform<span class="sort-arrow"></span></th>
            <th onclick="sortTable('cdp-table',5)" data-i18n="th_version">Version<span class="sort-arrow"></span></th>
            <th onclick="sortTable('cdp-table',6)">Native VLAN<span class="sort-arrow"></span></th>
            <th onclick="sortTable('cdp-table',7)" data-i18n="th_time">Time<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-cdp"><p data-i18n="empty_cdp">No CDP neighbors detected.</p></div>
    </div>

    <!-- Security Panel -->
    <div class="panel" id="panel-security">
      <h3 style="margin-bottom:12px" data-i18n="h_arp_alerts">ARP Spoofing Alerts</h3>
      <div style="overflow-x:auto">
      <table id="arp-alert-table">
        <thead>
          <tr>
            <th onclick="sortTable('arp-alert-table',0)" data-i18n="th_severity">Severity<span class="sort-arrow"></span></th>
            <th onclick="sortTable('arp-alert-table',1)" data-i18n="th_target_ip">Target IP<span class="sort-arrow"></span></th>
            <th onclick="sortTable('arp-alert-table',2)" data-i18n="th_known_mac">Known MAC<span class="sort-arrow"></span></th>
            <th onclick="sortTable('arp-alert-table',3)" data-i18n="th_attack_mac">Attacker MAC<span class="sort-arrow"></span></th>
            <th onclick="sortTable('arp-alert-table',4)" data-i18n="th_packets">Packets<span class="sort-arrow"></span></th>
            <th onclick="sortTable('arp-alert-table',5)" data-i18n="th_first_seen">First Seen<span class="sort-arrow"></span></th>
            <th onclick="sortTable('arp-alert-table',6)" data-i18n="th_last_seen">Last Seen<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-arp-alert"><p data-i18n="empty_arp">No ARP spoofing alerts.</p></div>

      <h3 style="margin:24px 0 12px" data-i18n="h_dns_alerts">DNS Spoofing Alerts</h3>
      <div style="overflow-x:auto">
      <table id="dns-alert-table">
        <thead>
          <tr>
            <th onclick="sortTable('dns-alert-table',0)" data-i18n="th_severity">Severity<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dns-alert-table',1)" data-i18n="th_type">Type<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dns-alert-table',2)" data-i18n="th_domain">Domain<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dns-alert-table',3)" data-i18n="th_message">Message<span class="sort-arrow"></span></th>
            <th onclick="sortTable('dns-alert-table',4)" data-i18n="th_time">Time<span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <div class="empty-state" id="empty-dns-alert"><p data-i18n="empty_dns">No DNS spoofing alerts.</p></div>
    </div>
  </div>
</div>

<!-- Alert Settings Modal -->
<div class="modal-overlay" id="alertModal" style="display:none" onclick="closeAlertModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 data-i18n="alert_title">Alert Settings</h3>
      <button onclick="closeAlertModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label" data-i18n="alert_subnets">Subnets to monitor</label>
        <div class="subnet-select" id="alertSubnetList"></div>
      </div>
      <div class="form-group">
        <label class="form-label" data-i18n="alert_events">Alert Events</label>
        <div class="subnet-select" id="alertEventList"></div>
      </div>
      <div class="form-group"><label class="form-label required" data-i18n="alert_smtp_from">From (Sender)</label><input class="form-input" id="alertSmtpFrom" placeholder="alert@example.com" required></div>
      <div class="form-group"><label class="form-label required" data-i18n="alert_smtp_to">Recipient</label><input class="form-input" id="alertSmtpTo" placeholder="admin@example.com" required></div>
      <div class="form-group"><label class="form-label required" data-i18n="alert_smtp_host">SMTP Host</label><input class="form-input" id="alertSmtpHost" placeholder="smtp.example.com" required></div>
      <div class="form-group"><label class="form-label" data-i18n="alert_smtp_port">SMTP Port</label><input class="form-input" id="alertSmtpPort" type="number" value="465"></div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="alertSmtpSSL" checked onchange="onSSLChange()"> <span data-i18n="alert_smtp_ssl">SSL/TLS</span></label>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="alertSmtpAuth" checked onchange="onAuthChange()"> <span data-i18n="alert_smtp_auth">Authentication</span></label>
      </div>
      <div id="alertFieldsAuth">
        <div class="form-group"><label class="form-label" data-i18n="alert_smtp_user">Username</label><input class="form-input" id="alertSmtpUser" placeholder="user@example.com"></div>
        <div class="form-group"><label class="form-label" data-i18n="alert_smtp_pass">Password</label><input class="form-input" id="alertSmtpPass" type="password"></div>
      </div>
      <div id="alertMsg"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btnAlertTest" onclick="testAlert()" data-i18n="btn_test">Test</button>
      <button class="btn" id="btnAlertCancel" onclick="cancelEditAlert()" style="display:none" data-i18n="btn_cancel">Cancel</button>
      <button class="btn btn-primary" id="btnAlertSave" onclick="saveAlert()" data-i18n="btn_save">Save</button>
    </div>
    <div class="alert-list" id="alertList"></div>
  </div>
</div>

<script>
// ── i18n ──
const i18n = {
  en: {
    title: 'Net Finder',
    btn_scan: 'Start Scan',
    btn_stop: 'Stop Scan',
    dark_mode: 'Dark',
    status_idle: 'Idle',
    status_running: 'Scanning',
    status_done: 'Done',
    tab_hosts: 'Hosts',
    tab_conflicts: 'IP Conflicts',
    tab_dhcp: 'DHCP Servers',
    tab_security: 'Security',
    search_hosts: 'Search (IP, hostname, MAC, vendor...)',
    search_generic: 'Search...',
    th_hostname: 'Hostname',
    th_vendor: 'Vendor',
    th_mac_addr: 'MAC Address',
    th_server_ip: 'Server IP',
    th_server_mac: 'Server MAC',
    th_offered_ip: 'Offered IP',
    th_subnet: 'Subnet',
    th_gateway: 'Gateway',
    th_lease: 'Lease Time',
    th_version: 'Version',
    th_group: 'Group',
    th_state: 'State',
    th_priority: 'Priority',
    th_virtual_ip: 'Virtual IP',
    th_source_ip: 'Source IP',
    th_time: 'Time',
    th_router_id: 'Router ID',
    th_adver_int: 'Adver Int',
    th_sys_name: 'System Name',
    th_sys_desc: 'System Desc',
    th_mgmt_addr: 'Mgmt Address',
    th_source_mac: 'Source MAC',
    th_device_id: 'Device ID',
    th_address: 'Address',
    th_platform: 'Platform',
    th_severity: 'Severity',
    th_target_ip: 'Target IP',
    th_known_mac: 'Known MAC',
    th_attack_mac: 'Attacker MAC',
    th_packets: 'Packets',
    th_first_seen: 'First Seen',
    th_last_seen: 'Last Seen',
    th_type: 'Type',
    th_domain: 'Domain',
    th_message: 'Message',
    h_lldp: 'LLDP Neighbors',
    h_cdp: 'CDP Neighbors',
    h_arp_alerts: 'ARP Spoofing Alerts',
    h_dns_alerts: 'DNS Spoofing Alerts',
    empty_hosts: 'Discovered hosts will appear here once scanning starts.',
    empty_conflicts: 'No IP conflicts detected.',
    empty_dhcp: 'No DHCP servers detected.',
    empty_hsrp: 'No HSRP packets detected.',
    empty_vrrp: 'No VRRP packets detected.',
    empty_lldp: 'No LLDP neighbors detected.',
    empty_cdp: 'No CDP neighbors detected.',
    empty_arp: 'No ARP spoofing alerts.',
    empty_dns: 'No DNS spoofing alerts.',
    hosts_count_one: ' host',
    hosts_count_other: ' hosts',
    items_count_one: ' item',
    items_count_other: ' items',
    other_group: '(Other)',
    lease_sec: 's',
    lease_min: 'm',
    lease_hour: 'h ',
    lease_day: 'd',
    prog_oui_loading: 'Loading OUI database...',
    prog_oui_done: 'OUI loaded ({0} vendors)',
    prog_scan_parallel: 'Parallel scanning (ARP, DHCP, HSRP/VRRP/LLDP/CDP)...',
    prog_scan_arp_done: 'ARP done ({0} hosts), resolving hostnames...',
    prog_scan_done: 'Scan complete',
    select_all: 'All',
    btn_alert_config: 'Alert Settings',
    alert_title: 'Alert Settings',
    alert_subnets: 'Subnets to monitor',
    alert_subnets_all: 'All subnets',
    alert_smtp_from: 'From (Sender)',
    alert_smtp_to: 'Recipient',
    alert_smtp_host: 'SMTP Host',
    alert_smtp_port: 'SMTP Port',
    alert_smtp_ssl: 'SSL/TLS',
    alert_smtp_auth: 'Authentication',
    alert_smtp_user: 'Username',
    alert_smtp_pass: 'Password',
    btn_test: 'Test',
    btn_save: 'Save',
    btn_update: 'Update',
    btn_cancel: 'Cancel',
    btn_edit: 'Edit',
    btn_delete: 'Delete',
    alert_events: 'Alert Events',
    alert_events_all: 'All events',
    alert_event_hosts: 'Host Discovery',
    alert_event_conflicts: 'IP Conflicts',
    alert_event_dhcp: 'DHCP Servers',
    alert_event_hsrp_vrrp: 'HSRP/VRRP',
    alert_event_lldp_cdp: 'LLDP/CDP',
    alert_event_arp: 'ARP Spoofing',
    alert_event_dns: 'DNS Spoofing',
    alert_required_fields: 'From, Recipient and SMTP Host are required',
    alert_test_ok: 'Test alert sent successfully',
    alert_test_fail: 'Test failed: {0}',
    alert_saved: 'Alert saved',
    alert_updated: 'Alert updated',
    alert_no_configs: 'No alert rules configured.',
  },
  ko: {
    title: 'Net Finder',
    btn_scan: '스캔 시작',
    btn_stop: '스캔 중지',
    dark_mode: '다크모드',
    status_idle: '대기',
    status_running: '스캔 중',
    status_done: '완료',
    tab_hosts: '호스트 목록',
    tab_conflicts: 'IP 충돌',
    tab_dhcp: 'DHCP 서버',
    tab_security: '보안',
    search_hosts: '검색 (IP, 호스트명, MAC, 벤더...)',
    search_generic: '검색...',
    th_hostname: '호스트명',
    th_vendor: '벤더',
    th_mac_addr: 'MAC 주소',
    th_server_ip: '서버 IP',
    th_server_mac: '서버 MAC',
    th_offered_ip: '제공 IP',
    th_subnet: '서브넷',
    th_gateway: '게이트웨이',
    th_lease: '임대시간',
    th_version: '버전',
    th_group: '그룹',
    th_state: '상태',
    th_priority: '우선순위',
    th_virtual_ip: '가상 IP',
    th_source_ip: '소스 IP',
    th_time: '시간',
    th_router_id: '라우터 ID',
    th_adver_int: '광고 간격',
    th_sys_name: '시스템 이름',
    th_sys_desc: '시스템 설명',
    th_mgmt_addr: '관리 주소',
    th_source_mac: '소스 MAC',
    th_device_id: '장치 ID',
    th_address: '주소',
    th_platform: '플랫폼',
    th_severity: '심각도',
    th_target_ip: '대상 IP',
    th_known_mac: '알려진 MAC',
    th_attack_mac: '공격 MAC',
    th_packets: '패킷 수',
    th_first_seen: '최초 감지',
    th_last_seen: '마지막 감지',
    th_type: '유형',
    th_domain: '도메인',
    th_message: '메시지',
    h_lldp: 'LLDP 이웃',
    h_cdp: 'CDP 이웃',
    h_arp_alerts: 'ARP 스푸핑 알림',
    h_dns_alerts: 'DNS 스푸핑 알림',
    empty_hosts: '스캔을 시작하면 발견된 호스트가 여기에 표시됩니다.',
    empty_conflicts: 'IP 충돌이 감지되지 않았습니다.',
    empty_dhcp: 'DHCP 서버가 감지되지 않았습니다.',
    empty_hsrp: 'HSRP 패킷이 감지되지 않았습니다.',
    empty_vrrp: 'VRRP 패킷이 감지되지 않았습니다.',
    empty_lldp: 'LLDP 이웃이 감지되지 않았습니다.',
    empty_cdp: 'CDP 이웃이 감지되지 않았습니다.',
    empty_arp: 'ARP 스푸핑 알림이 없습니다.',
    empty_dns: 'DNS 스푸핑 알림이 없습니다.',
    hosts_count_one: '개 호스트',
    hosts_count_other: '개 호스트',
    items_count_one: '건',
    items_count_other: '건',
    other_group: '(기타)',
    lease_sec: '초',
    lease_min: '분',
    lease_hour: '시간 ',
    lease_day: '일',
    prog_oui_loading: 'OUI 데이터베이스 로드 중...',
    prog_oui_done: 'OUI 로드 완료 ({0}개 벤더)',
    prog_scan_parallel: '병렬 스캔 중 (ARP, DHCP, HSRP/VRRP/LLDP/CDP)...',
    prog_scan_arp_done: 'ARP 완료 ({0}개 호스트), 호스트명 해석 중...',
    prog_scan_done: '스캔 완료',
    select_all: '전체',
    btn_alert_config: '알림 설정',
    alert_title: '알림 설정',
    alert_subnets: '감시 대역',
    alert_subnets_all: '전체 대역',
    alert_smtp_from: '보낸 사람 주소',
    alert_smtp_to: '수신자',
    alert_smtp_host: 'SMTP 호스트',
    alert_smtp_port: 'SMTP 포트',
    alert_smtp_ssl: 'SSL/TLS',
    alert_smtp_auth: '인증',
    alert_smtp_user: '사용자명',
    alert_smtp_pass: '비밀번호',
    btn_test: '테스트',
    btn_save: '저장',
    btn_update: '수정',
    btn_cancel: '취소',
    btn_edit: '수정',
    btn_delete: '삭제',
    alert_events: '알림 대상',
    alert_events_all: '전체 이벤트',
    alert_event_hosts: '호스트 발견',
    alert_event_conflicts: 'IP 충돌',
    alert_event_dhcp: 'DHCP 서버 발견',
    alert_event_hsrp_vrrp: 'HSRP/VRRP 발견',
    alert_event_lldp_cdp: 'LLDP/CDP 발견',
    alert_event_arp: 'ARP 스푸핑',
    alert_event_dns: 'DNS 스푸핑',
    alert_required_fields: '보내는 주소, 수신자, SMTP 호스트는 필수 항목입니다',
    alert_test_ok: '테스트 알림 발송 성공',
    alert_test_fail: '테스트 실패: {0}',
    alert_saved: '알림 저장 완료',
    alert_updated: '알림 수정 완료',
    alert_no_configs: '설정된 알림 규칙이 없습니다.',
  }
};

let currentLang = 'en';

function t(key) {
  return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;
}

function tp(key, count) {
  const suffix = count === 1 ? '_one' : '_other';
  return t(key + suffix);
}

function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('lang', lang);
  document.documentElement.lang = lang;
  document.getElementById('langSelect').value = lang;
  applyLanguage();
}

function applyLanguage() {
  document.title = t('title');
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const arrow = el.querySelector('.sort-arrow');
    el.textContent = t(key);
    if (arrow) el.appendChild(arrow);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
  // Re-render dynamic content
  if (rawHosts.length > 0 || rawConflicts.length > 0) {
    renderSubnetFilter('hosts', knownSubnets.hosts);
    renderSubnetFilter('conflicts', knownSubnets.conflicts);
    renderHostsTable();
    renderConflictsTable();
  }
}

function initLanguage() {
  const saved = localStorage.getItem('lang');
  if (saved && i18n[saved]) {
    currentLang = saved;
  }
  document.getElementById('langSelect').value = currentLang;
  applyLanguage();
}

// ── State ──
let currentTab = 'hosts';
let pollTimer = null;

// Raw data (kept across polls so render can use sort/collapse state)
let rawHosts = [];
let rawConflicts = [];

// MAC→IP lookup (built from rawHosts each poll)
let macToIP = {};

// IP→conflict lookup (built from rawConflicts each poll)
let conflictMap = {};

// Collapse state per table: Set of collapsed subnet strings
const collapsed = { hosts: new Set(), conflicts: new Set() };

// Subnet filter: Set of enabled (checked) subnets per panel
const enabledSubnets = { hosts: new Set(), conflicts: new Set() };
// Track known subnets to detect changes
let knownSubnets = { hosts: [], conflicts: [] };
let scannerSubnets = []; // subnets configured in scanner

// Sort state per table: { col, asc } or null
const activeSort = {};

// Search filter per table
const activeFilter = {};

// ── Theme ──
function initTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('themeSwitch').checked = true;
  }
}
function toggleTheme() {
  const isDark = document.getElementById('themeSwitch').checked;
  if (isDark) {
    document.documentElement.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('theme', 'light');
  }
}

// ── Tabs ──
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
}

// ── Scan controls ──
async function startScan() {
  try { await fetch('/api/scan/start', { method: 'POST' }); } catch(e) { console.error(e); }
}
async function stopScan() {
  try { await fetch('/api/scan/stop', { method: 'POST' }); } catch(e) { console.error(e); }
}

// ── Polling ──
async function fetchJSON(url) { const r = await fetch(url); return r.json(); }

async function pollData() {
  try {
    const status = await fetchJSON('/api/status');
    updateStatus(status);

    const [hosts, conflicts, dhcp, hsrp, vrrp, lldp, cdp, arpAlerts, dnsAlerts] = await Promise.all([
      fetchJSON('/api/hosts'),
      fetchJSON('/api/conflicts'),
      fetchJSON('/api/dhcp'),
      fetchJSON('/api/hsrp'),
      fetchJSON('/api/vrrp'),
      fetchJSON('/api/lldp'),
      fetchJSON('/api/cdp'),
      fetchJSON('/api/security/arp'),
      fetchJSON('/api/security/dns')
    ]);

    rawHosts = hosts || [];
    rawConflicts = conflicts || [];

    // Build MAC→IP lookup from hosts
    macToIP = {};
    rawHosts.forEach(h => {
      macToIP[h.mac.toUpperCase()] = h.ip;
      if (h.bondMACs) h.bondMACs.forEach(m => { macToIP[m.toUpperCase()] = h.ip; });
    });

    // Build IP→conflict lookup
    conflictMap = {};
    rawConflicts.forEach(c => { conflictMap[c.ip] = c; });

    // Update subnet filters
    const hostsGrouped = groupBySubnet(rawHosts);
    const conflictsGrouped = groupBySubnet(rawConflicts);
    updateSubnetSets('hosts', hostsGrouped.order);
    updateSubnetSets('conflicts', conflictsGrouped.order);
    renderSubnetFilter('hosts', hostsGrouped.order);
    renderSubnetFilter('conflicts', conflictsGrouped.order);

    renderHostsTable();
    renderConflictsTable();
    renderSimpleTable('dhcp-table', 'empty-dhcp', dhcp, renderDHCPRow);
    renderSimpleTable('hsrp-table', 'empty-hsrp', hsrp, renderHSRPRow);
    renderSimpleTable('vrrp-table', 'empty-vrrp', vrrp, renderVRRPRow);

    // LLDP/CDP: default sort by device ID
    const sortedLLDP = [...(lldp||[])].sort((a,b) => (a.chassisID||'').localeCompare(b.chassisID||''));
    const sortedCDP = [...(cdp||[])].sort((a,b) => (a.deviceID||'').localeCompare(b.deviceID||''));
    renderSimpleTable('lldp-table', 'empty-lldp', sortedLLDP, renderLLDPRow);
    renderSimpleTable('cdp-table', 'empty-cdp', sortedCDP, renderCDPRow);
    renderSimpleTable('arp-alert-table', 'empty-arp-alert', arpAlerts, renderARPAlertRow);
    renderSimpleTable('dns-alert-table', 'empty-dns-alert', dnsAlerts, renderDNSAlertRow);
    updateBadges(rawHosts, rawConflicts, dhcp, arpAlerts, dnsAlerts);
  } catch(e) { console.error('Poll error:', e); }
}

function progressMessage(p) {
  if (!p || !p.phase) return '';
  const key = 'prog_' + p.phase;
  const tmpl = t(key);
  if (tmpl === key) return p.phase;
  return tmpl.replace('{0}', p.count || 0);
}

function updateStatus(data) {
  const badge = document.getElementById('statusBadge');
  const bar = document.getElementById('progressBar');
  const desc = document.getElementById('progressDesc');
  const pct = document.getElementById('progressPercent');
  badge.className = 'status-badge status-' + data.status;
  badge.textContent = t('status_' + data.status) || data.status;
  const p = data.progress || {};
  bar.style.width = (p.percent || 0) + '%';
  desc.textContent = progressMessage(p);
  pct.textContent = (p.percent || 0) + '%';
  document.getElementById('btnScan').disabled = data.status === 'running';
  document.getElementById('btnStop').disabled = data.status !== 'running';
  if (data.subnets && data.subnets.length > 0) scannerSubnets = data.subnets;
}

function updateBadges(hosts, conflicts, dhcp, arpAlerts, dnsAlerts) {
  setBadge('badge-hosts', hosts.length);
  setBadge('badge-conflicts', conflicts.length);
  setBadge('badge-dhcp', dhcp.length);
  setBadge('badge-security', arpAlerts.length + dnsAlerts.length);
}
function setBadge(id, count) {
  const el = document.getElementById(id);
  if (count > 0) { el.textContent = count; el.style.display = 'inline-block'; }
  else { el.style.display = 'none'; }
}

// ── Grouping ──
function groupBySubnet(items) {
  const groups = {}, order = [];
  items.forEach(item => {
    const key = item.subnet || t('other_group');
    if (!groups[key]) { groups[key] = []; order.push(key); }
    groups[key].push(item);
  });
  order.sort((a, b) => {
    const pa = a.split('/')[0] || '', pb = b.split('/')[0] || '';
    if (isIP(pa) && isIP(pb)) return compareIP(pa, pb);
    return a.localeCompare(b);
  });
  return { groups, order };
}

// ── Subnet filter checkboxes ──
function updateSubnetSets(panelKey, subnets) {
  // Add newly discovered subnets (default: enabled)
  for (const s of subnets) {
    if (!enabledSubnets[panelKey].has(s) && !knownSubnets[panelKey].includes(s)) {
      enabledSubnets[panelKey].add(s);
    }
  }
  // On first load, enable all
  if (knownSubnets[panelKey].length === 0 && subnets.length > 0) {
    subnets.forEach(s => enabledSubnets[panelKey].add(s));
  }
  knownSubnets[panelKey] = subnets;
}

function renderSubnetFilter(panelKey, subnets) {
  const container = document.getElementById('subnet-filter-' + panelKey);
  if (!container) return;
  if (subnets.length === 0) { container.innerHTML = ''; return; }

  const enabled = enabledSubnets[panelKey];
  const allChecked = subnets.every(s => enabled.has(s));
  const noneChecked = subnets.every(s => !enabled.has(s));

  let html = '<label><input type="checkbox" id="sf-all-' + panelKey + '"'
    + (allChecked ? ' checked' : '')
    + ' onchange="toggleAllSubnets(\'' + panelKey + '\', this.checked)">'
    + ' ' + esc(t('select_all')) + '</label>';

  for (const subnet of subnets) {
    html += '<label><input type="checkbox" data-panel="' + panelKey + '" data-subnet="' + escAttr(subnet) + '"'
      + (enabled.has(subnet) ? ' checked' : '')
      + ' onchange="toggleSubnetFilter(\'' + panelKey + '\',\'' + escAttr(subnet) + '\', this.checked)">'
      + ' ' + esc(subnet) + '</label>';
  }
  container.innerHTML = html;

  // Set indeterminate state for "All" checkbox
  const allCb = document.getElementById('sf-all-' + panelKey);
  if (allCb) allCb.indeterminate = !allChecked && !noneChecked;
}

function toggleAllSubnets(panelKey, checked) {
  const subnets = knownSubnets[panelKey];
  enabledSubnets[panelKey].clear();
  if (checked) subnets.forEach(s => enabledSubnets[panelKey].add(s));
  renderSubnetFilter(panelKey, subnets);
  if (panelKey === 'hosts') renderHostsTable();
  else renderConflictsTable();
}

function toggleSubnetFilter(panelKey, subnet, checked) {
  if (checked) enabledSubnets[panelKey].add(subnet);
  else enabledSubnets[panelKey].delete(subnet);
  // Update "All" checkbox state
  const subnets = knownSubnets[panelKey];
  const allCb = document.getElementById('sf-all-' + panelKey);
  if (allCb) {
    const allChecked = subnets.every(s => enabledSubnets[panelKey].has(s));
    const noneChecked = subnets.every(s => !enabledSubnets[panelKey].has(s));
    allCb.checked = allChecked;
    allCb.indeterminate = !allChecked && !noneChecked;
  }
  if (panelKey === 'hosts') renderHostsTable();
  else renderConflictsTable();
}

// ── Hosts table (grouped) ──
const hostsFields = [null, 'ip', 'hostname', 'mac', 'vendor'];

function renderHostsTable() {
  const tbody = document.querySelector('#hosts-table tbody');
  const empty = document.getElementById('empty-hosts');
  if (rawHosts.length === 0) { tbody.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';

  const sort = activeSort['hosts-table'];
  const filter = (activeFilter['hosts-table'] || '').toLowerCase();
  const { groups, order } = groupBySubnet(rawHosts);
  const cols = 5;
  let html = '';
  let idx = 0;

  for (const subnet of order) {
    if (!enabledSubnets.hosts.has(subnet)) continue;
    let items = groups[subnet];
    // Sort within group
    if (sort && hostsFields[sort.col]) {
      const field = hostsFields[sort.col];
      items = [...items].sort((a, b) => fieldCompare(a[field] || '', b[field] || '', sort.asc));
    } else {
      items = [...items].sort((a, b) => compareIP(a.ip, b.ip));
    }

    // Filter
    const filtered = filter
      ? items.filter(h => `${h.ip} ${h.hostname||''} ${h.mac} ${h.vendor} ${(h.bondMACs||[]).join(' ')} ${(h.bondVendors||[]).join(' ')}`.toLowerCase().includes(filter))
      : items;
    if (filter && filtered.length === 0) continue;

    const isCollapsed = collapsed.hosts.has(subnet);
    const arrow = isCollapsed ? '\u25B6' : '\u25BC';
    const shown = filter ? filtered.length : items.length;
    html += `<tr class="subnet-header" onclick="toggleSubnet('hosts','${escAttr(subnet)}')"><td colspan="${cols}"><span class="collapse-arrow">${arrow}</span> ${esc(subnet)}<span class="subnet-count">${shown}${tp('hosts_count', shown)}</span></td></tr>`;

    if (!isCollapsed) {
      for (const h of filtered) {
        idx++;
        const conf = conflictMap[h.ip];
        let macCell, vendorCell, badge = '', rowClass = '';
        if (conf) {
          macCell = (conf.macs||[]).map(esc).join('<br>');
          vendorCell = (conf.vendors||[]).map(esc).join('<br>');
          badge = ' <span class="text-danger" style="font-size:11px;font-weight:600">[Conflicted]</span>';
          rowClass = ' class="severity-critical"';
        } else if (h.isBond && h.bondMACs && h.bondMACs.length > 0) {
          macCell = h.bondMACs.map(esc).join('<br>');
          vendorCell = (h.bondVendors||[]).map(esc).join('<br>');
          badge = ' <span class="text-cyan" style="font-size:11px;font-weight:600">[Multi-NIC/Bond]</span>';
        } else {
          macCell = esc(h.mac);
          vendorCell = esc(h.vendor);
        }
        html += `<tr${rowClass}><td>${idx}</td><td>${esc(h.ip)}${badge}</td><td>${esc(h.hostname||'-')}</td><td class="mac-cell">${macCell}</td><td>${vendorCell}</td></tr>`;
      }
    }
  }
  tbody.innerHTML = html;
  updateSortArrows('hosts-table');
}

// ── Conflicts table (grouped) ──
const conflictsFields = ['ip', 'hostname', 'macs', 'vendors'];

function renderConflictsTable() {
  const tbody = document.querySelector('#conflicts-table tbody');
  const empty = document.getElementById('empty-conflicts');
  if (rawConflicts.length === 0) { tbody.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';

  const sort = activeSort['conflicts-table'];
  const filter = (activeFilter['conflicts-table'] || '').toLowerCase();
  const { groups, order } = groupBySubnet(rawConflicts);
  const cols = 4;
  let html = '';

  for (const subnet of order) {
    if (!enabledSubnets.conflicts.has(subnet)) continue;
    let items = groups[subnet];
    if (sort && conflictsFields[sort.col]) {
      const field = conflictsFields[sort.col];
      items = [...items].sort((a, b) => {
        const va = Array.isArray(a[field]) ? a[field].join(' ') : (a[field]||'');
        const vb = Array.isArray(b[field]) ? b[field].join(' ') : (b[field]||'');
        return fieldCompare(va, vb, sort.asc);
      });
    } else {
      items = [...items].sort((a, b) => compareIP(a.ip, b.ip));
    }

    const filtered = filter
      ? items.filter(c => `${c.ip} ${c.hostname||''} ${(c.macs||[]).join(' ')} ${(c.vendors||[]).join(' ')}`.toLowerCase().includes(filter))
      : items;
    if (filter && filtered.length === 0) continue;

    const isCollapsed = collapsed.conflicts.has(subnet);
    const arrow = isCollapsed ? '\u25B6' : '\u25BC';
    html += `<tr class="subnet-header" onclick="toggleSubnet('conflicts','${escAttr(subnet)}')"><td colspan="${cols}"><span class="collapse-arrow">${arrow}</span> ${esc(subnet)}<span class="subnet-count">${filtered.length}${tp('items_count', filtered.length)}</span></td></tr>`;

    if (!isCollapsed) {
      for (const c of filtered) {
        html += `<tr class="severity-critical"><td>${esc(c.ip)}</td><td>${esc(c.hostname||'-')}</td><td class="mac-cell">${(c.macs||[]).map(esc).join('<br>')}</td><td>${(c.vendors||[]).map(esc).join('<br>')}</td></tr>`;
      }
    }
  }
  tbody.innerHTML = html;
  updateSortArrows('conflicts-table');
}

// ── Toggle collapse ──
function toggleSubnet(tableKey, subnet) {
  const set = collapsed[tableKey];
  if (set.has(subnet)) set.delete(subnet); else set.add(subnet);
  if (tableKey === 'hosts') renderHostsTable();
  else renderConflictsTable();
}

// ── Simple table renderer (non-grouped tables) ──
function renderSimpleTable(tableId, emptyId, data, rowFn) {
  const tbody = document.querySelector('#' + tableId + ' tbody');
  const empty = document.getElementById(emptyId);
  if (!data || data.length === 0) { tbody.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';

  const sort = activeSort[tableId];
  let rows = data;
  if (sort) {
    rows = [...data].sort((a, b) => {
      const va = rowToText(rowFn(a), sort.col);
      const vb = rowToText(rowFn(b), sort.col);
      return fieldCompare(va, vb, sort.asc);
    });
  }
  tbody.innerHTML = rows.map(rowFn).join('');
}

function rowToText(html, colIdx) {
  const tmp = document.createElement('tr');
  tmp.innerHTML = html.replace(/^<tr[^>]*>/, '').replace(/<\/tr>$/, '');
  return tmp.cells[colIdx]?.textContent.trim() || '';
}

// Row renderers
function renderDHCPRow(s) {
  return `<tr><td>${esc(s.serverIP)}</td><td class="mac-cell">${esc(s.serverMAC)}</td><td>${esc(s.vendor)}</td><td>${esc(s.offeredIP)}</td><td>${esc(s.subnetMask)}</td><td>${esc(s.router)}</td><td>${(s.dns||[]).map(esc).join(', ')}</td><td>${formatLease(s.leaseTime)}</td></tr>`;
}
function renderHSRPRow(e) {
  return `<tr><td>v${e.version}</td><td>${e.group}</td><td>${esc(e.state)}</td><td>${e.priority}</td><td>${esc(e.virtualIP)}</td><td>${esc(e.sourceIP)}</td><td>${e.helloTime}s / ${e.holdTime}s</td><td>${esc(e.timestamp)}</td></tr>`;
}
function renderVRRPRow(e) {
  return `<tr><td>v${e.version}</td><td>${e.routerID}</td><td>${e.priority}</td><td>${(e.ipAddresses||[]).map(esc).join(', ')}</td><td>${esc(e.sourceIP)}</td><td>${e.adverInt}s</td><td>${esc(e.timestamp)}</td></tr>`;
}
function lookupMAC(mac) {
  if (!mac) return '';
  return macToIP[mac.toUpperCase()] || '';
}
function renderLLDPRow(e) {
  const addr = e.mgmtAddr || lookupMAC(e.sourceMAC) || lookupMAC(e.chassisID) || '';
  return `<tr><td>${esc(e.chassisID)}</td><td>${esc(e.portID)}</td><td>${esc(e.sysName)}</td><td>${esc(e.sysDesc)}</td><td>${esc(addr)}</td><td class="mac-cell">${esc((e.sourceMAC||'').toUpperCase())}</td><td>${e.ttl}</td><td>${esc(e.timestamp)}</td></tr>`;
}
function renderCDPRow(e) {
  let addrs = e.addresses || [];
  if (addrs.length === 0) {
    const ip = lookupMAC(e.sourceMAC);
    if (ip) addrs = [ip];
  }
  return `<tr><td>${esc(e.deviceID)}</td><td>${addrs.map(esc).join(', ')}</td><td class="mac-cell">${esc((e.sourceMAC||'').toUpperCase())}</td><td>${esc(e.portID)}</td><td>${esc(e.platform)}</td><td>${esc(e.version)}</td><td>${e.nativeVLAN||'-'}</td><td>${esc(e.timestamp)}</td></tr>`;
}
function renderARPAlertRow(a) {
  const sevClass = a.severity==='critical'?'danger':'warning';
  return `<tr class="severity-${a.severity}"><td><span class="text-${sevClass}">${a.severity.toUpperCase()}</span></td><td>${esc(a.ip)}</td><td class="mac-cell">${esc(a.oldMAC)}</td><td class="mac-cell">${esc(a.newMAC)}</td><td><strong>${a.count||1}</strong></td><td>${esc(a.firstSeen||a.timestamp)}</td><td>${esc(a.timestamp)}</td></tr>`;
}
function renderDNSAlertRow(a) {
  return `<tr class="severity-${a.severity}"><td><span class="text-${a.severity==='critical'?'danger':'warning'}">${a.severity.toUpperCase()}</span></td><td>${esc(a.alertType)}</td><td>${esc(a.domain)}</td><td>${esc(a.message)}</td><td>${esc(a.timestamp)}</td></tr>`;
}

// ── Helpers ──
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escAttr(s) {
  return esc(s).replace(/'/g,'&#39;');
}
function formatLease(seconds) {
  if (!seconds) return '-';
  if (seconds < 60) return seconds + t('lease_sec');
  if (seconds < 3600) return Math.floor(seconds/60) + t('lease_min');
  if (seconds < 86400) return Math.floor(seconds/3600) + t('lease_hour') + Math.floor((seconds%3600)/60) + t('lease_min');
  return Math.floor(seconds/86400) + t('lease_day');
}
function isIP(s) { return /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(s); }
function compareIP(a, b) {
  const pa = (a||'0.0.0.0').split('.').map(Number);
  const pb = (b||'0.0.0.0').split('.').map(Number);
  for (let i = 0; i < 4; i++) { if (pa[i] !== pb[i]) return pa[i] - pb[i]; }
  return 0;
}
function fieldCompare(va, vb, asc) {
  if (isIP(va) && isIP(vb)) return asc ? compareIP(va, vb) : compareIP(vb, va);
  const na = parseFloat(va), nb = parseFloat(vb);
  if (!isNaN(na) && !isNaN(nb)) return asc ? na - nb : nb - na;
  return asc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
}

// ── Sort ──
function sortTable(tableId, colIdx) {
  const prev = activeSort[tableId];
  if (prev && prev.col === colIdx) {
    if (prev.asc) {
      // asc → clear sort (back to default grouping)
      delete activeSort[tableId];
    } else {
      // desc → asc
      activeSort[tableId] = { col: colIdx, asc: true };
    }
  } else {
    // New column → start descending (visible change from default order)
    activeSort[tableId] = { col: colIdx, asc: false };
  }

  // Re-render from data
  if (tableId === 'hosts-table') { renderHostsTable(); return; }
  if (tableId === 'conflicts-table') { renderConflictsTable(); return; }

  // For simple tables: re-trigger from last poll data (let next poll handle it)
  // But we can also sort DOM immediately for responsiveness
  const table = document.getElementById(tableId);
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  if (rows.length === 0) return;
  const sort = activeSort[tableId];
  rows.sort((a, b) => {
    const va = a.cells[sort.col]?.textContent.trim() || '';
    const vb = b.cells[sort.col]?.textContent.trim() || '';
    return fieldCompare(va, vb, sort.asc);
  });
  rows.forEach(r => tbody.appendChild(r));
  updateSortArrows(tableId);
}

function updateSortArrows(tableId) {
  const table = document.getElementById(tableId);
  table.querySelectorAll('th .sort-arrow').forEach(a => a.textContent = '');
  const sort = activeSort[tableId];
  if (!sort) return;
  const th = table.querySelectorAll('th')[sort.col];
  if (th) {
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.textContent = sort.asc ? ' \u25B2' : ' \u25BC';
  }
}

// ── Filter ──
function filterTable(tableId, query) {
  activeFilter[tableId] = query;
  if (tableId === 'hosts-table') { renderHostsTable(); return; }
  if (tableId === 'conflicts-table') { renderConflictsTable(); return; }
  // DOM filter for simple tables
  const table = document.getElementById(tableId);
  const rows = table.querySelectorAll('tbody tr');
  const q = query.toLowerCase();
  rows.forEach(row => {
    row.style.display = (!q || row.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
}

// ── Alert Modal ──
let editingAlertId = null;

function getAlertSubnets() {
  return (scannerSubnets.length > 0 ? scannerSubnets : (knownSubnets.hosts.length > 0 ? knownSubnets.hosts : knownSubnets.conflicts))
    .slice().sort((a, b) => { const pa = a.split('/')[0]||'', pb = b.split('/')[0]||''; return isIP(pa) && isIP(pb) ? compareIP(pa, pb) : a.localeCompare(b); });
}

function populateAlertSubnets(selectedSubnets) {
  const container = document.getElementById('alertSubnetList');
  const subnets = getAlertSubnets();
  const isAll = !selectedSubnets || selectedSubnets.length === 0;
  let html = '<label><input type="checkbox" id="alertSubnetAll"' + (isAll ? ' checked' : '') + ' onchange="toggleAlertSubnetsAll(this.checked)"> ' + esc(t('alert_subnets_all')) + '</label>';
  for (const s of subnets) {
    const checked = isAll || selectedSubnets.includes(s);
    html += '<label><input type="checkbox" class="alert-subnet-cb" value="' + escAttr(s) + '"' + (checked ? ' checked' : '') + ' onchange="updateAlertSubnetAll()"> ' + esc(s) + '</label>';
  }
  container.innerHTML = html;
  if (!isAll) updateAlertSubnetAll();
}

function setEditMode(editing) {
  editingAlertId = editing ? editingAlertId : null;
  const saveBtn = document.getElementById('btnAlertSave');
  const cancelBtn = document.getElementById('btnAlertCancel');
  if (editing) {
    saveBtn.textContent = t('btn_update');
    saveBtn.setAttribute('data-i18n', 'btn_update');
    cancelBtn.style.display = '';
  } else {
    saveBtn.textContent = t('btn_save');
    saveBtn.setAttribute('data-i18n', 'btn_save');
    cancelBtn.style.display = 'none';
  }
}

function resetAlertForm() {
  editingAlertId = null;
  document.getElementById('alertSmtpFrom').value = '';
  document.getElementById('alertSmtpHost').value = '';
  document.getElementById('alertSmtpPort').value = '465';
  document.getElementById('alertSmtpSSL').checked = true;
  document.getElementById('alertSmtpAuth').checked = true;
  document.getElementById('alertFieldsAuth').style.display = '';
  document.getElementById('alertSmtpUser').value = '';
  document.getElementById('alertSmtpPass').value = '';
  document.getElementById('alertSmtpTo').value = '';
  document.getElementById('alertMsg').innerHTML = '';
  populateAlertSubnets(null);
  populateAlertEvents(null);
  setEditMode(false);
}

function openAlertModal() {
  document.getElementById('alertModal').style.display = '';
  resetAlertForm();
  loadAlertConfigs();
}

function closeAlertModal(event) {
  if (event && event.target !== document.getElementById('alertModal')) return;
  document.getElementById('alertModal').style.display = 'none';
}

function onSSLChange() {
  const ssl = document.getElementById('alertSmtpSSL').checked;
  const portEl = document.getElementById('alertSmtpPort');
  if (ssl && portEl.value === '587') portEl.value = '465';
  else if (!ssl && portEl.value === '465') portEl.value = '587';
}

function onAuthChange() {
  document.getElementById('alertFieldsAuth').style.display = document.getElementById('alertSmtpAuth').checked ? '' : 'none';
}

function toggleAlertSubnetsAll(checked) {
  document.querySelectorAll('.alert-subnet-cb').forEach(cb => cb.checked = checked);
  const allCb = document.getElementById('alertSubnetAll');
  if (allCb) { allCb.checked = checked; allCb.indeterminate = false; }
}

function updateAlertSubnetAll() {
  const cbs = document.querySelectorAll('.alert-subnet-cb');
  const allCb = document.getElementById('alertSubnetAll');
  if (!allCb || cbs.length === 0) return;
  const checkedCount = document.querySelectorAll('.alert-subnet-cb:checked').length;
  if (checkedCount === cbs.length) {
    allCb.checked = true;
    allCb.indeterminate = false;
  } else if (checkedCount === 0) {
    allCb.checked = false;
    allCb.indeterminate = false;
  } else {
    allCb.checked = false;
    allCb.indeterminate = true;
  }
}

const alertEventKeys = ['hosts', 'conflicts', 'dhcp', 'hsrp_vrrp', 'lldp_cdp', 'arp_spoofing', 'dns_spoofing'];

const alertEventI18n = { hosts:'alert_event_hosts', conflicts:'alert_event_conflicts', dhcp:'alert_event_dhcp', hsrp_vrrp:'alert_event_hsrp_vrrp', lldp_cdp:'alert_event_lldp_cdp', arp_spoofing:'alert_event_arp', dns_spoofing:'alert_event_dns' };

function populateAlertEvents(selectedEvents) {
  const container = document.getElementById('alertEventList');
  const isAll = !selectedEvents || selectedEvents.length === 0;
  let html = '<label><input type="checkbox" id="alertEventAll"' + (isAll ? ' checked' : '') + ' onchange="toggleAlertEventsAll(this.checked)"> ' + esc(t('alert_events_all')) + '</label>';
  for (const key of alertEventKeys) {
    const checked = isAll || selectedEvents.includes(key);
    html += '<label><input type="checkbox" class="alert-event-cb" value="' + escAttr(key) + '"' + (checked ? ' checked' : '') + ' onchange="updateAlertEventAll()"> ' + esc(t(alertEventI18n[key])) + '</label>';
  }
  container.innerHTML = html;
  if (!isAll) updateAlertEventAll();
}

function toggleAlertEventsAll(checked) {
  document.querySelectorAll('.alert-event-cb').forEach(cb => cb.checked = checked);
  const allCb = document.getElementById('alertEventAll');
  if (allCb) { allCb.checked = checked; allCb.indeterminate = false; }
}

function updateAlertEventAll() {
  const cbs = document.querySelectorAll('.alert-event-cb');
  const allCb = document.getElementById('alertEventAll');
  if (!allCb || cbs.length === 0) return;
  const checkedCount = document.querySelectorAll('.alert-event-cb:checked').length;
  if (checkedCount === cbs.length) {
    allCb.checked = true;
    allCb.indeterminate = false;
  } else if (checkedCount === 0) {
    allCb.checked = false;
    allCb.indeterminate = false;
  } else {
    allCb.checked = false;
    allCb.indeterminate = true;
  }
}

function getAlertFormData() {
  const smtpFrom = document.getElementById('alertSmtpFrom').value.trim();
  const smtpTo = document.getElementById('alertSmtpTo').value.trim();
  const smtpHost = document.getElementById('alertSmtpHost').value.trim();
  if (!smtpFrom || !smtpTo || !smtpHost) {
    showAlertMsg(false, t('alert_required_fields'));
    if (!smtpFrom) document.getElementById('alertSmtpFrom').focus();
    else if (!smtpTo) document.getElementById('alertSmtpTo').focus();
    else document.getElementById('alertSmtpHost').focus();
    return null;
  }
  const cbs = document.querySelectorAll('.alert-subnet-cb');
  const checkedCount = document.querySelectorAll('.alert-subnet-cb:checked').length;
  const allChecked = cbs.length > 0 && checkedCount === cbs.length;
  let subnets = [];
  if (!allChecked) {
    document.querySelectorAll('.alert-subnet-cb:checked').forEach(cb => subnets.push(cb.value));
  }
  // Collect events
  const evCbs = document.querySelectorAll('.alert-event-cb');
  const evCheckedCount = document.querySelectorAll('.alert-event-cb:checked').length;
  const evAllChecked = evCbs.length > 0 && evCheckedCount === evCbs.length;
  let events = [];
  if (!evAllChecked) {
    document.querySelectorAll('.alert-event-cb:checked').forEach(cb => events.push(cb.value));
  }
  const cfg = {
    subnets: subnets,
    events: events,
    type: 'email',
    smtpFrom: smtpFrom,
    smtpTo: smtpTo,
    smtpHost: smtpHost,
    smtpPort: parseInt(document.getElementById('alertSmtpPort').value) || 465,
    smtpSSL: document.getElementById('alertSmtpSSL').checked,
    smtpAuth: document.getElementById('alertSmtpAuth').checked,
  };
  if (cfg.smtpAuth) {
    cfg.smtpUser = document.getElementById('alertSmtpUser').value;
    cfg.smtpPass = document.getElementById('alertSmtpPass').value;
  }
  return cfg;
}

function showAlertMsg(ok, text) {
  const el = document.getElementById('alertMsg');
  el.innerHTML = '<div class="alert-msg ' + (ok ? 'alert-msg-ok' : 'alert-msg-err') + '">' + esc(text) + '</div>';
  setTimeout(() => { el.innerHTML = ''; }, 4000);
}

async function saveAlert() {
  const cfg = getAlertFormData();
  if (!cfg) return;
  try {
    const method = editingAlertId ? 'PUT' : 'POST';
    if (editingAlertId) cfg.id = editingAlertId;
    const resp = await fetch('/api/alerts', { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(cfg) });
    const data = await resp.json();
    if (data.status === 'error') {
      showAlertMsg(false, data.message || 'Error');
      return;
    }
    if (editingAlertId) {
      showAlertMsg(true, t('alert_updated'));
      resetAlertForm();
    } else {
      showAlertMsg(true, t('alert_saved'));
    }
    loadAlertConfigs();
  } catch(e) {
    showAlertMsg(false, e.message);
  }
}

function editAlert(id) {
  fetch('/api/alerts').then(r => r.json()).then(configs => {
    const cfg = (configs || []).find(c => c.id === id);
    if (!cfg) return;
    editingAlertId = id;
    document.getElementById('alertSmtpFrom').value = cfg.smtpFrom || '';
    document.getElementById('alertSmtpTo').value = cfg.smtpTo || '';
    document.getElementById('alertSmtpHost').value = cfg.smtpHost || '';
    document.getElementById('alertSmtpPort').value = cfg.smtpPort || 465;
    document.getElementById('alertSmtpSSL').checked = !!cfg.smtpSSL;
    document.getElementById('alertSmtpAuth').checked = !!cfg.smtpAuth;
    document.getElementById('alertFieldsAuth').style.display = cfg.smtpAuth ? '' : 'none';
    document.getElementById('alertSmtpUser').value = cfg.smtpUser || '';
    document.getElementById('alertSmtpPass').value = cfg.smtpPass || '';
    populateAlertSubnets(cfg.subnets);
    populateAlertEvents(cfg.events);
    setEditMode(true);
    document.getElementById('alertMsg').innerHTML = '';
    // Scroll to top of modal
    document.querySelector('#alertModal .modal').scrollTop = 0;
  });
}

function cancelEditAlert() {
  resetAlertForm();
}

async function testAlert() {
  const cfg = getAlertFormData();
  if (!cfg) return;
  try {
    const resp = await fetch('/api/alerts/test', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(cfg) });
    const data = await resp.json();
    if (data.status === 'ok') {
      showAlertMsg(true, t('alert_test_ok'));
    } else {
      showAlertMsg(false, t('alert_test_fail').replace('{0}', data.message || ''));
    }
  } catch(e) {
    showAlertMsg(false, t('alert_test_fail').replace('{0}', e.message));
  }
}

async function deleteAlert(id) {
  try {
    await fetch('/api/alerts?id=' + encodeURIComponent(id), { method: 'DELETE' });
    loadAlertConfigs();
  } catch(e) { console.error(e); }
}

async function loadAlertConfigs() {
  try {
    const configs = await fetchJSON('/api/alerts');
    renderAlertList(configs || []);
  } catch(e) { console.error(e); }
}

function renderAlertList(configs) {
  const container = document.getElementById('alertList');
  if (configs.length === 0) {
    container.innerHTML = '<div style="padding:12px 20px 16px;color:var(--text-secondary);font-size:13px" data-i18n="alert_no_configs">' + esc(t('alert_no_configs')) + '</div>';
    return;
  }
  let html = '';
  for (const c of configs) {
    const subnetsLabel = c.subnets && c.subnets.length > 0 ? c.subnets.join(', ') : t('alert_subnets_all');
    const eventsLabel = c.events && c.events.length > 0 ? c.events.map(e => t(alertEventI18n[e] || e)).join(', ') : t('alert_events_all');
    const fromTo = (c.smtpFrom || '?') + ' &rarr; ' + (c.smtpTo || '?');
    const flags = [c.smtpHost + ':' + (c.smtpPort||465), c.smtpSSL ? 'SSL' : 'STARTTLS', c.smtpAuth ? 'AUTH' : ''].filter(Boolean).join(' | ');
    html += '<div class="alert-list-item"><div class="alert-info"><strong>EMAIL</strong> &mdash; ' + fromTo + '<br><span style="font-size:12px;color:var(--text-secondary)">' + esc(flags) + ' / ' + esc(subnetsLabel) + '<br>' + esc(eventsLabel) + '</span></div>'
      + '<div style="display:flex;gap:4px">'
      + '<button class="btn-sm btn-primary" onclick="editAlert(\'' + escAttr(c.id) + '\')" data-i18n="btn_edit">' + esc(t('btn_edit')) + '</button>'
      + '<button class="btn-sm btn-danger" onclick="deleteAlert(\'' + escAttr(c.id) + '\')" data-i18n="btn_delete">' + esc(t('btn_delete')) + '</button>'
      + '</div></div>';
  }
  container.innerHTML = html;
}

// ── Init ──
initTheme();
initLanguage();
pollData();
pollTimer = setInterval(pollData, 2000);
</script>
</body>
</html>
